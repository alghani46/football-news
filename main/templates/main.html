{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Football News</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-gray-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

<!-- Header Section -->
<div class="mb-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-2">Latest Football News</h1>
  <p class="text-gray-600">Stay updated with the latest football stories and analysis</p>
</div>

<!-- Button to open modal -->
<button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-white text-green-600 font-semibold outline outline-2 outline-green-600 rounded-md hover:bg-green-600 hover:text-white transition-colors mb-4">
  Create News by AJAX
</button>

    <!-- Modal for AJAX News Creation -->
    <div id="newsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
        <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-xl">&times;</button>
        <h2 class="text-xl font-bold mb-4">Create News</h2>

        <form id="ajaxNewsForm">
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input type="text" name="title" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-green-500">
          </div>

          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
            <textarea name="content" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-green-500"></textarea>
          </div>

          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select name="category" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-green-500">
              <option value="transfer">Transfer</option>
              <option value="update">Update</option>
              <option value="exclusive">Exclusive</option>
              <option value="match">Match</option>
              <option value="rumor">Rumor</option>
              <option value="analysis">Analysis</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail URL</label>
            <input type="url" name="thumbnail" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:border-green-500">
          </div>

          <div class="flex items-center mb-4">
            <input type="checkbox" name="is_featured" id="is_featured" class="mr-2">
            <label for="is_featured" class="text-sm text-gray-700">Featured</label>
          </div>

          <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 font-semibold transition-colors">
            Submit
          </button>
        </form>

        <div id="ajaxNewsError" class="text-red-600 mt-3 hidden"></div>
      </div>
    </div>

    <!-- Personal Info Section -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Football News</h1>
      <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
        <h4 class="font-semibold">NPM:</h4>
        <p>{{ npm }}</p>
        <h4 class="font-semibold">Name:</h4>
        <p>{{ name }}</p>
        <h4 class="font-semibold">Class:</h4>
        <p>{{ class }}</p>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <a href="?filter=all" class="{% if request.GET.filter == 'all' or not request.GET.filter %} bg-green-600 text-white{% else %} bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white">
          All News
        </a>
        <a href="?filter=my" class="{% if request.GET.filter == 'my' %} bg-green-600 text-white{% else %} bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-green-600 hover:text-white">
          My News
        </a>
      </div>
      {% if user.is_authenticated %}
      <div class="text-sm text-gray-500">
        Last login: {{ last_login }}
      </div>
      {% endif %}
    </div>

    <!-- Add News & Logout Buttons -->
    {% if user.is_authenticated %}
    <a href="{% url 'main:create_news' %}" class="inline-flex items-center px-4 py-2 mb-6 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
      Add News
    </a>
    <a href="{% url 'main:logout' %}" class="inline-flex items-center px-4 py-2 mb-6 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
      Logout
    </a>
    {% endif %}

    <!-- News Grid or Empty State -->
    {% if not news_list %}
      <div class="bg-white rounded-lg border border-gray-200 p-12 text-center">
        <div class="w-32 h-32 mx-auto mb-4">
          <img src="{% static 'image/no-news.png' %}" alt="No news available" class="w-full h-full object-contain">
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No news found</h3>
        <p class="text-gray-500 mb-6">Be the first to share football news with the community.</p>
        <a href="{% url 'main:create_news' %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
          Create News
        </a>
      </div>
    {% else %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for news in news_list %}
          {% include 'card_news.html' with news=news %}
        {% endfor %}
      </div>
    {% endif %}

  </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  function showModal() {
    document.getElementById('newsModal').classList.remove('hidden');
  }
  function closeModal() {
    document.getElementById('newsModal').classList.add('hidden');
    document.getElementById('ajaxNewsError').classList.add('hidden');
    document.getElementById('ajaxNewsForm').reset();
  }
  window.showModal = showModal;
  window.closeModal = closeModal;

  document.getElementById('ajaxNewsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => {
      if (key === 'is_featured') {
        data[key] = form.elements['is_featured'].checked;
      } else {
        data[key] = value;
      }
    });
    try {
      const response = await fetch("{% url 'main:add_news_entry_ajax' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(data)
      });
      if (!response.ok) throw new Error("Failed to create news");
      closeModal();
      if (typeof fetchNewsFromServer === "function") fetchNewsFromServer();
    } catch (err) {
      const errorDiv = document.getElementById('ajaxNewsError');
      errorDiv.textContent = err.message;
      errorDiv.classList.remove('hidden');
    }
  });

  // Add event listener to detect new news
  document.addEventListener('newsAdded', function() {
    fetchNewsFromServer();
  });
});
</script>

<script>
function buildNewsCardElement(item) {
    const article = document.createElement('article');
    article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

    const linkDetail = `{% url 'main:show_news' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
    const linkEdit = `{% url 'main:edit_news' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
    const linkDelete = `{% url 'main:delete_news' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

    const title = DOMPurify.sanitize(item.title);
    const content = DOMPurify.sanitize(item.content);
    const category = DOMPurify.sanitize(item.category);
    const thumbnail = item.thumbnail || '';
    const createdAt = new Date(item.created_at).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
    const newsViews = item.news_views;
    const isFeatured = item.is_featured;
    const isHot = newsViews > 20;

    const thumbnailHtml = thumbnail 
        ? `<img src="${DOMPurify.sanitize(thumbnail)}" alt="${title}" class="w-full h-full object-cover">` 
        : `<div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center"></div>`;

    const categoryLabel = DOMPurify.sanitize(getReadableCategoryName(category));
    const featuredLabel = isFeatured ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Featured</span>` : '';
    const hotLabel = isHot ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800">Hot</span>` : '';

    const editDeleteHtml = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(item.user_id)
        ? `<div class="flex space-x-2">
            <a href="${linkEdit}" class="text-gray-600 hover:text-gray-700 text-sm transition-colors">Edit</a>
            <a href="${linkDelete}" class="text-red-600 hover:text-red-700 text-sm transition-colors" onclick="return confirm('Are you sure you want to delete this article?')">Delete</a>
          </div>`
        : '';

    const cardHtml = `
        <div class="aspect-[16/9] relative overflow-hidden">
          ${thumbnailHtml}
          <div class="absolute top-3 left-3">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-green-600 text-white">${categoryLabel}</span>
          </div>
          <div class="absolute top-3 right-3 flex space-x-2">
            ${featuredLabel}
            ${hotLabel}
          </div>
        </div>
        <div class="p-5 flex flex-col flex-1">
          <div class="flex items-center text-sm text-gray-500 mb-3">
            <time>${createdAt}</time>
            <span class="mx-2">•</span>
            <span>${newsViews} views</span>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
            <a href="${linkDetail}" class="hover:text-green-600 transition-colors">${title}</a>
          </h3>
          <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${content}</p>
          <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
            <a href="${linkDetail}" class="text-green-600 hover:text-green-700 font-medium text-sm transition-colors">Read more</a>
            ${editDeleteHtml}
          </div>
        </div>
    `;
    
    article.innerHTML = cardHtml;
    return article;
}
</script>
{% endblock content %}
